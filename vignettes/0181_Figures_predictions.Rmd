---
title: "Untitled"
author: "Nadege Belouard"
date: "4/11/2022"
output: html_document
---

(3) Finally, we will use the knowledge we have on the location of SLF jumpers relative to transports, to project potential areas of colonization over six states (PA, WV, VA, MD, DE, NJ). We will assess the proportion of high-risk locations that are situated in this zone, and whether there are variations between categories of high-risk locations.


Check the position of jumps relative to these intersects
```{r jumps map}

#load the resulting shapefile
roadrail_intersect <- st_read(file.path(here(), "figures", "GIS", "roadrail200m_dissolve.shp"), quiet = T)
roadrail_intersect <- st_read(file.path(here(), "figures", "GIS", "roadrail100m_union.shp"), quiet = T)

#load the jumps file
jump_groups <- read.csv(file.path(here(), "exported-data", "jump_groups.csv"))

pal <- colorFactor(rep(rainbow(5), 8), 
                   domain = unique(jump_groups$Group))

leaflet(data = jump_groups) %>% 
  addTiles() %>% 
  addPolygons(data = roadrail_intersect) %>%
  addCircleMarkers(lng = ~longitude_rounded, 
                       lat = ~latitude_rounded, 
                       color = ~pal(Group), 
                       label = ~Group)  

```


# 3. Intersection of risk zones

If we create a buffer around roads and railways so as to include all jumpers, we can design a map of locations at risk of jump dispersal (Figure 8). In other words, all jump dispersal identified so far occurred within the orange buffer. This type of map can be used to concentrate survey efforts on locations considered at risk based on spread records.

```{r show buffer intersecting road and rail, fig.height=4, fig.width = 6, fig.cap="Buffer zones around railways and roads that include all jumpers"}

max(jumpers_DP16GS15$DistToAirport) #30295.97 m
quantile(jumpers_DP16GS15$DistToAirport,c(.025,.975))

max(jumpers_DP16GS15$DistToRail) #21189 m
quantile(jumpers_DP16GS15$DistToRail,c(.025,.975)) #10829 m 
quantile(jumpers_DP16GS15$DistToRail,c(.05,.95)) # 8391 m
quantile(jumpers_DP16GS15$DistToRail,c(.1,.9)) # 4889 m

max(jumpers_DP16GS15$DistToRoad) #10360.52 m
quantile(jumpers_DP16GS15$DistToRoad,c(.025,.975)) #3172 m 
quantile(jumpers_DP16GS15$DistToRoad,c(.05,.95)) # 2031 m
quantile(jumpers_DP16GS15$DistToRoad,c(.1,.9)) # 1211 m

railroad <- merge(rail, road)

Buffer_risk <- ggplot(data = world) +
    geom_sf() +
    geom_sf(data = states, fill = "white") +
    geom_sf(data = Railroad_buffer, fill = "orange") +
    coord_sf(xlim = c(-81, -73), ylim = c(38, 42.5), expand = FALSE) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top")

Buffer_risk

# ggsave("../figures/vignette_highrisk/bufferrisk_railroad.jpg", Buffer_risk, width = 6, height = 4)
```


High-risk areas were listed because they concentrate flow of people. It is interesting to see if they are situated in the buffer where actual jump events were found.

```{r show buffer intersecting road and rail with high risk areas, fig.height=4, fig.width = 6, fig.cap="Location of high-risk areas relative to the buffer zones including all jumpers"}
HighRiskLoc <- st_read("../GIS/HighRiskLoc.shp", quiet = T)

Highrisk_buffer <- ggplot(data = world) +
    geom_sf() +
    geom_sf(data = states, fill = "white") +
    # geom_sf(data = Railroad_buffer, fill = "orange") +
  geom_sf(data = HighRiskLoc, aes(col = InBuffer)) +
    coord_sf(xlim = c(-81, -73), ylim = c(38, 42.5), expand = FALSE) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top")

Highrisk_buffer

# ggsave("../figures/vignette_highrisk/highrisk_buffer.jpg", Highrisk_buffer, width = 6, height = 6)
```

The green-blue dots represent high-risk area situated within the risk buffer, and red points are high-risk areas outside of this buffer (Figure 9). A substantial proportion of high-risk areas are thus at risk. We can look further into it by checking whether this varies between categories of high-risk areas.

```{r barplot of the proportion of high-risk locations included in risk buffer per category, fig.height=3, fig.width = 9, fig.cap="Proportion of in-buffer high-risk locations per category"}

Prophighrisk_inbuffer <- ggplot(HighRiskLoc, aes(x = category)) + 
  geom_bar(aes(fill = InBuffer), position="fill") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

Prophighrisk_inbuffer

# ggsave("../figures/vignette_highrisk/Prophighrisk_inbuffer.jpg", Prophighrisk_inbuffer, width = 9, height = 3)
```

We notice on Figure 10 that most campgrounds, race tracks, saw mills and summer camps are situated outside of the risk buffer. It could mean that these locations are generally not at risk compared to the others.


```{r buffers around rail and roads}
# Full dataset
# Rail
rail_21180 <- st_buffer(rail, dist = 21180) #100% jumps
st_write(rail_21180, file.path(here(), "figures", "GIS", "rail_buffer_21180.shp"))

rail_6570 <- st_buffer(rail, dist = 6570) #95% jumps
st_write(rail_6570, file.path(here(), "figures", "GIS", "rail_buffer_6570.shp"))

rail_1340 <- st_buffer(rail, dist = 1340) #75% jumps
st_write(rail_1340, file.path(here(), "figures", "GIS", "rail_buffer_1340.shp"))


# Rarefied dataset
rail_9790 <- st_buffer(rail, dist = 9790) #100% jumps
st_write(rail_9790, file.path(here(), "figures", "GIS", "rail_buffer_9790.shp"))

rail_7120 <- st_buffer(rail, dist = 7120) #95% jumps
st_write(rail_7120, file.path(here(), "figures", "GIS", "rail_buffer_7120.shp"))

rail_2590 <- st_buffer(rail, dist = 2590) #75% jumps
st_write(rail_2590, file.path(here(), "figures", "GIS", "rail_buffer_2590.shp"))

# Road
road_3570 <- st_buffer(road, dist = 3570) #100% jumps
st_write(road_3570, file.path(here(), "figures", "GIS", "road_buffer_3570.shp"))

road_1810 <- st_buffer(road, dist = 1810) #95% jumps
st_write(road_1810, file.path(here(), "figures", "GIS", "road_buffer_1810.shp"))

road_730 <- st_buffer(road, dist = 730) #75% jumps
st_write(road_730, file.path(here(), "figures", "GIS", "road_buffer_730.shp"))


# Rarefied dataset
road_3370 <- st_buffer(road, dist = 3370) #100% jumps
st_write(road_3370, file.path(here(), "figures", "GIS", "road_buffer_3370.shp"))

road_2970 <- st_buffer(road, dist = 2970) #95% jumps
st_write(road_2970, file.path(here(), "figures", "GIS", "road_buffer_2970.shp"))

road_980 <- st_buffer(road, dist = 980) #75% jumps
st_write(road_980, file.path(here(), "figures", "GIS", "road_buffer_980.shp"))


# Intersections
# Full dataset
Rail_road_full_100 <- st_intersection(rail_21180, road_3570)
st_write(Rail_road_full_100, file.path(here(), "figures", "GIS", "road_rail_intersect_full_100.shp"))

Rail_road_full_95 <- st_intersection(rail_6570, road_1810)
st_write(Rail_road_full_95, file.path(here(), "figures", "GIS", "road_rail_intersect_full_95.shp"))

Rail_road_full_75 <- st_intersection(rail_1340, road_730)
st_write(Rail_road_full_75, file.path(here(), "figures", "GIS", "road_rail_intersect_full_75.shp"))

# Rare dataset
Rail_road_rare_100 <- st_intersection(rail_9790, road_3370)
st_write(Rail_road_rare_100, file.path(here(), "figures", "GIS", "road_rail_intersect_rare_100.shp"))

Rail_road_rare_95 <- st_intersection(rail_7120, road_2970)
st_write(Rail_road_rare_95, file.path(here(), "figures", "GIS", "road_rail_intersect_rare_95.shp"))

Rail_road_rare_75 <- st_intersection(rail_2590, road_980)
st_write(Rail_road_rare_75, file.path(here(), "figures", "GIS", "road_rail_intersect_rare_75.shp"))
dim(Rail_road_rare_75)
```

# Airports, ports
```{r airports, ports}

## SLF dropped at destination:
# through people transportation:

# Primary airports (points, buffer radius = 1 000 m)
# List given by FAA, location given by National Transportation Dataset (USGS)
airports <- st_read(filepath(here(), "C:/Users/labuser/Documents/Postdoc_SLF/SLF_Dispersal/data/raw_data/Transport/Airports/airports_primary_buffer.shp"), quiet = T)
airports <- st_transform(airports, crs = "ESRI:102010")
st_crs(airports)

# Through goods transportation:
# Ports (points, buffer radius = 200 m)
# These are ports as defined by the USGS ScienceBase-Catalog
ports <- st_read("C:/Users/labuser/Documents/Postdoc_SLF/SLF_Dispersal/data/raw_data/Transport/Ports/Ports_projected_buffer200.shp", quiet = T)
st_crs(ports)
```


## Risk buffer
```{r map risk buffer}

rail_6570 <- st_read(file.path(here(), "figures", "GIS", "rail_buffer_6570.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  geom_sf(data = rail_6570, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_rail_6570.jpg"), rail, width = 6, height = 6)


####


rail_1340 <- st_read(file.path(here(), "figures", "GIS", "rail_buffer_1340.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  geom_sf(data = rail_1340, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_rail_1340.jpg"), rail, width = 6, height = 6)



####


rail_21180 <- st_read(file.path(here(), "figures", "GIS", "rail_buffer_21180.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  # geom_sf(data = rail_21180, fill = "yellow", col = "yellow") +
    geom_sf(data = rail_6570, fill = "orange", col = "orange") +
    geom_sf(data = rail_1340, fill = "red", col = "red") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_rail_95_75.jpg"), rail, width = 6, height = 6)




### roads

####


road_1810 <- st_read(file.path(here(), "figures", "GIS", "road_buffer_1810.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  # geom_sf(data = rail_21180, fill = "yellow", col = "yellow") +
    # geom_sf(data = rail_6570, fill = "orange", col = "orange") +
    geom_sf(data = road_1810, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_road_1810.jpg"), rail, width = 6, height = 6)



### 

road_730 <- st_read(file.path(here(), "figures", "GIS", "road_buffer_730.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  # geom_sf(data = rail_21180, fill = "yellow", col = "yellow") +
    # geom_sf(data = rail_6570, fill = "orange", col = "orange") +
    geom_sf(data = road_730, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_road_730.jpg"), rail, width = 6, height = 6)



## intersect

road_rail_75 <- st_read(file.path(here(), "figures", "GIS", "road_rail_intersect_full_75.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  # geom_sf(data = rail_21180, fill = "yellow", col = "yellow") +
    # geom_sf(data = rail_6570, fill = "orange", col = "orange") +
    geom_sf(data = road_rail_75, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_roadrail_75.jpg"), rail, width = 6, height = 6)

aaa
```


## Are airports and ports far from roads and railroads?
```{r check distance airports with railroads and roads}

# Calculate the distances to transport infrastructures (from the data frame)
airports %<>% add_column(DistToRail = NA,
                         DistToRoad = NA) %>% 
  st_cast("POLYGON")

# Visualize shapefiles
ggplot(data = states) +
    geom_sf(fill = "white") +
  geom_sf(data = airports, col = "blue") +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top")


#Calculate their distance to transport infrastructures
for (j in 1:length(airports$DistToRail)){ 
  print(j)
  point_clip <- st_buffer(airports[j,], dist = 5000)
  
  road_clip <- st_intersection(road, point_clip)
  dist_road <- st_distance(x = airports[j,], y = road_clip)
  airports$DistToRoad[j] <- min(dist_road)
  
  rail_clip <- st_intersection(rail, point_clip)
  dist_rail <- st_distance(x = airports[j,], y = rail_clip)
  airports$DistToRail[j] <- min(dist_rail)
}

airports %>% filter(DistToRail == Inf | is.na(DistToRail))
airports %>% filter(DistToRoad == Inf | is.na(DistToRoad))

for (j in 1:length(airports$DistToRail)){ 
  if (airports$DistToRail[j] == Inf){
    print(j)

    # Calculate distance to the closest railroad
    dist_rail <- st_distance(x = airports[j,], y = rail)
    airports$DistToRail[j] <- min(dist_rail)
  }
  
  if (airports$DistToRoad[j] == Inf){
    print(j)

    # Calculate distance to the closest road
    dist_road <- st_distance(x = airports[j,], y = road)
    airports$DistToRoad[j] <- min(dist_road)
  }
}


## Same for ports
ports %<>% add_column(DistToRail = NA,
                      DistToRoad = NA) %>% 
  st_cast("POLYGON")

for (j in 1:length(ports$DistToRail)){ 
  print(j)
  point_clip <- st_buffer(ports[j,], dist = 1000)
  
  road_clip <- st_intersection(road, point_clip)
  dist_road <- st_distance(x = ports[j,], y = road_clip)
  ports$DistToRoad[j] <- min(dist_road)
  
  rail_clip <- st_intersection(rail, point_clip)
  dist_rail <- st_distance(x = ports[j,], y = rail_clip)
  ports$DistToRail[j] <- min(dist_rail)
}


ports %>% filter(DistToRail == Inf | is.na(DistToRail))
ports %>% filter(DistToRoad == Inf | is.na(DistToRoad))
``` 


\newpage
