---
title: "Predictions of slf jumps - buffers around landscape features"
author: "Nadege Belouard"
date: "4/11/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

We will use the knowledge we have on the location of SLF jumps location so far to project potential areas of colonization.

# 1. Setup

## Load packages
```{r setup for rendering, include = F, messages = F, warning = F}

# attaching necessary packages
library(tidyverse)
library(magrittr)
library(sf)
library(maps)
library(DescTools)
library(reshape2)
library(ggplot2)
library(here)
library(slfjumps)
library(leaflet)
library(purrr)
library(cowplot)
library(geosphere)

sf::sf_use_s2(FALSE)
```

## States map
```{r states names and centroid for global map, message = FALSE, warning = FALSE, echo = params$display}
# extracts a map of the States and recodes state labels to show the two-letter code rather than the full state name.

# obtaining simple feature objects for states and finding centroids for label positioning
states <- sf::st_as_sf(maps::map("state", plot = FALSE, fill = TRUE))
states <- st_transform(states, crs = "ESRI:102010")
# sf::st_as_sf(maps::map("county", plot = TRUE, fill = FALSE))
states <- cbind(states, st_coordinates(st_centroid(states)))


# making table key for state 2-letter abbreviations
# the vectors state.abb and state.name contains strings of all
# US states and abbreviations
state_abbr <- tibble(state.name = str_to_lower(state.name), state.abb) %>%
  left_join(tibble(ID = states$ID), ., by = c(ID = "state.name")) %>%
  mutate(state.abb = replace_na(state.abb, ""))

# adding 2-letter codes to sf
states$code <- state_abbr$state.abb


ggplot() +
    geom_sf(data = states, alpha = 0) +
  geom_text(data = states, aes(X, Y, label = code), size = 2) 

```



## Load files
```{r load datasets for analysis}
slf_uptodate <- read.csv(file.path(here(), "exported-data", "slf_obs_uptodate.csv"), h=T)
slfPA_uptodate <- read.csv(file.path(here(), "exported-data", "slfPA_uptodate.csv"), h=T)
hull <- st_read(file.path(here(), "figures", "GIS", "chull.shp"), quiet = T)
st_area(hull) #173,517,523,874 m2 = 173,517 km2
Thresholds <- read.csv(file.path(here(), "exported-data", "thresholds.csv"))
```

Map points
```{r map points}

# take data on all diffusers
diffusers <- slf_uptodate %>% filter(Category_full == "Diffusers")

diffusers <- st_as_sf(x = diffusers, coords = c("longitude_rounded", "latitude_rounded"), crs = "EPSG:4269", remove = F)

# take data on all thresholds/invasion fronts
head(Thresholds)
thresholds <- st_as_sf(x = Thresholds %>% filter(bio_year == 2020), coords = c("longitude_rounded", "latitude_rounded"), crs = "EPSG:4269", remove = F) 

# map them
ggplot(data = states) +
  geom_sf() +
  geom_sf(data = diffusers, col = "red") +
  geom_sf(data = thresholds) +
  coord_sf(xlim = c(1000000, 2000000), ylim = c(-200000, 600000), expand = FALSE)
```

# 2. Buffer around invasion front
We want to create a buffer around the invasion front that represents the predicted zone where jumps can happen, to subset the zone in the US that might be at risk.
The maximal distance between the invasion front and a jump recorded is 309 km, the distance of 95% of the jumps is 263 km (rarefied dataset), and the average distance is 88 km (rarefied dataset). 
So we will use a buffer of 263 km.

```{r buffer around invasion front}
# We first need to create a polyon that represents the invasion front. It's not a minimum convex hull!
# We do this step on ArcGIS because it is easier than on sf
invasion_front <- st_read(file.path(here(), "figures", "GIS", "invasion_front.shp"), quiet = T)
st_crs(invasion_front)

# map that
ggplot(data = states) +
  geom_sf() +
  geom_sf(data = invasion_front, fill = "white") +
  # geom_sf(data = diffusers, col = "red") +
  coord_sf(xlim = c(1000000, 2000000), ylim = c(-200000, 600000), expand = FALSE)

# Create a buffer around it
invasion_front <- st_transform(invasion_front, crs = "ESRI:102010")
buffer_invasion_front <- st_buffer(invasion_front, dist = 263000)


ggplot(data = states) +
  geom_sf() +
  geom_sf(data = buffer_invasion_front) +
  # geom_sf(data = diffusers) +
  coord_sf(xlim = c(1000000, 2000000), ylim = c(-200000, 600000), expand = FALSE)


# Remove the area that is already colonized
atrisk_zone <- st_difference(buffer_invasion_front, invasion_front)

# Map it
ggplot(data = states) +
  geom_sf() +
  geom_sf(data = atrisk_zone, fill = "blue", alpha = 0.5) +
  geom_sf(data = diffusers) +
  coord_sf(xlim = c(1000000, 2000000), ylim = c(-200000, 600000), expand = FALSE)


st_write(atrisk_zone, file.path(here(), "figures", "GIS", "atrisk_zone.shp"), append = F)
```



# 3. Intersect landscape features and at risk zone

## Load all landscape features
And create buffer around them
```{r load landscape features}

# Mail carriers
mail <- st_read(file.path(here(), "figures", "GIS", "landscape", "mail_buffer.shp"), quiet = T)

# Wood activities
wood <- st_read(file.path(here(), "figures", "GIS", "landscape", "wood_buffer.shp"), quiet = T)

# Wineries
wineries <- st_read(file.path(here(), "figures", "GIS", "landscape", "wineries_buffer.shp"), quiet = T)

# People
people <- st_read(file.path(here(), "figures", "GIS", "landscape", "people_buffer.shp"), quiet = T)

# Garages
garages <- st_read(file.path(here(), "figures", "GIS", "landscape", "garages_buffer.shp"), quiet = T)

# Boats
boats <- st_read(file.path(here(), "figures", "GIS", "landscape", "boats_buffer.shp"), quiet = T)

# Airports
airports <- st_read(file.path(here(), "figures", "GIS", "airports_primary_buffer.shp"), quiet = T)
airports <- st_transform(airports, crs = "ESRI:102010")

# Rail
rail <- st_read(file.path(here(), "figures", "GIS", "Railways_full_buffer5m.shp"), quiet = T)

# Road
road <- st_read(file.path(here(), "figures", "GIS", "road_buffer15m.shp"), quiet = T)

# Intersect of rail and road
roadrail_intersect <- st_read(file.path(here(), "figures", "GIS", "roadrail100m_union.shp"), quiet = T)
roadrail_intersect <- st_transform(roadrail_intersect, crs = "ESRI:102010")

```


## Intersect all landscape layers with at risk zone
```{r intersect with at risk zone}

# At risk zone
atrisk_zone <- st_read(file.path(here(), "figures", "GIS", "atrisk_zone.shp"), quiet = T)

mail_zone <- st_intersection(mail, atrisk_zone) %>% 
  st_union()
st_write(mail_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "mail_zone.shp"), quiet = T, append = F)

wood_zone <- st_intersection(wood, atrisk_zone) %>% 
  st_union()
st_write(wood_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "wood_zone.shp"), quiet = T, append = F)

wineries_zone <- st_intersection(wineries, atrisk_zone) %>% 
  st_union()
st_write(wineries_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "wineries_zone.shp"), quiet = T, append = F)

people_zone <- st_intersection(people, atrisk_zone) %>% 
  st_union()
st_write(people_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "people_zone.shp"), quiet = T, append = F)

garages_zone <- st_intersection(garages, atrisk_zone) %>% 
  st_union()
st_write(garages_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "garages_zone.shp"), quiet = T, append = F)

boats_zone <- st_intersection(boats, atrisk_zone) %>% 
  st_union()
st_write(boats_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "boats_zone.shp"), quiet = T, append = F)

airports_zone <- st_intersection(airports, atrisk_zone) %>% 
  st_union()
st_write(airports_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "airports_zone.shp"), quiet = T, append = F)

rail_zone <- st_intersection(rail, atrisk_zone) %>% 
  st_union()
st_write(rail_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "rail_zone.shp"), quiet = T, append = F)

road_zone <- st_intersection(road, atrisk_zone) %>% 
  st_union()
st_write(road_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "road_zone.shp"), quiet = T, append = F)

roadrail_intersect_zone <- st_intersection(roadrail_intersect, atrisk_zone) %>% 
  st_union()
st_write(roadrail_intersect_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "roadrail_intersect_zone.shp"), quiet = T, append = F)


# Map it
ggplot(data = states) +
  geom_sf() +
  geom_sf(data = atrisk_zone, fill = "blue", alpha = 0.5) #+
  # geom_sf(data = roadrail_intersect_zone) +
  # coord_sf(xlim = c(1000000, 2000000), ylim = c(-200000, 600000), expand = FALSE)

```


# 4. Create maps!

## Load packages
```{r setup for rendering, include = F, messages = F, warning = F}

# attaching necessary packages
library(tidyverse)
library(magrittr)
library(sf)
library(DescTools)
library(here)
library(leaflet)
library(purrr)
library(geosphere)
```

## Load data
```{r load landscape features}
# Jump data
slf_uptodate <- read.csv(file.path(here(), "exported-data", "slf_obs_uptodate.csv"), h=T)
slfPA_uptodate <- read.csv(file.path(here(), "exported-data", "slfPA_uptodate.csv"), h=T)

# At risk zone
atrisk_zone <- st_read(file.path(here(), "figures", "GIS", "atrisk_zone.shp"), quiet = T)

mail_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "mail_zone.shp"), quiet = T)

wood_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "wood_zone.shp"), quiet = T)

wineries_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "wineries_zone.shp"), quiet = T)

people_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "people_zone.shp"), quiet = T)

garages_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "garages_zone.shp"), quiet = T)

boats_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "boats_zone.shp"), quiet = T)

airports_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "airports_zone.shp"), quiet = T)

rail_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "rail_zone.shp"), quiet = T)
rail_zone <- st_simplify(rail_zone)
st_write(rail_zone, file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "rail_zone_simple.shp"))

road_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "road_zone.shp"), quiet = T)

roadrail_intersect_zone <- st_read(file.path(here(), "figures", "GIS", "landscape_zoneatrisk", "roadrail_intersect_zone.shp"), quiet = T)
```

Steps: 
(0) choose layer and risk level
(1) calculate distance with risk level
(2) make buffer with this distance

```{r make landscape layer buffers}

jumps <- slf_uptodate %>% filter(Category_rare == "Jumpers")
jumpsPA <- slfPA_uptodate %>% filter(Category_rare == "Jumpers")
jumps <- merge(jumps, jumpsPA, all = T)
# write.csv(jumps, file.path(here(), "..", "slfjump_app", "data", "jumps.csv"))

dist <- jumps[which(names(jumps) == 'DistToRail')]
risk = 0.95 
threshold <- quantile(dist[1], probs = risk, na.rm = T)

buffer <- st_buffer(rail_zone, dist = threshold)
st_area(buffer)/sum(st_area(states))

```

Map it! With leaflet: requires to transform layers to WGS84
```{r jumps map}

atrisk_zone <- atrisk_zone %>% st_transform(crs = "+proj=longlat +datum=WGS84") 
buffer <- buffer %>% st_transform(crs = "+proj=longlat +datum=WGS84") 

leaflet(data = buffer) %>% 
  addTiles() %>% 
  addPolygons() %>% 
  # addPolygons(data = rail_zone, col = "black") %>%
  addPolygons(data = atrisk_zone, fillColor = "red", weight = 0.1)

```



## Not run: pre-load buffers for rail and roads
```{r buffers around rail and roads}
# Full dataset
# Rail
rail_21180 <- st_buffer(rail, dist = 21180) #100% jumps
st_write(rail_21180, file.path(here(), "figures", "GIS", "rail_buffer_21180.shp"))

rail_6570 <- st_buffer(rail, dist = 6570) #95% jumps
st_write(rail_6570, file.path(here(), "figures", "GIS", "rail_buffer_6570.shp"))

rail_1340 <- st_buffer(rail, dist = 1340) #75% jumps
st_write(rail_1340, file.path(here(), "figures", "GIS", "rail_buffer_1340.shp"))


# Rarefied dataset
rail_9790 <- st_buffer(rail, dist = 9790) #100% jumps
st_write(rail_9790, file.path(here(), "figures", "GIS", "rail_buffer_9790.shp"))

rail_7120 <- st_buffer(rail, dist = 7120) #95% jumps
st_write(rail_7120, file.path(here(), "figures", "GIS", "rail_buffer_7120.shp"))

rail_2590 <- st_buffer(rail, dist = 2590) #75% jumps
st_write(rail_2590, file.path(here(), "figures", "GIS", "rail_buffer_2590.shp"))

# Road
road_3570 <- st_buffer(road, dist = 3570) #100% jumps
st_write(road_3570, file.path(here(), "figures", "GIS", "road_buffer_3570.shp"))

road_1810 <- st_buffer(road, dist = 1810) #95% jumps
st_write(road_1810, file.path(here(), "figures", "GIS", "road_buffer_1810.shp"))

road_730 <- st_buffer(road, dist = 730) #75% jumps
st_write(road_730, file.path(here(), "figures", "GIS", "road_buffer_730.shp"))


# Rarefied dataset
road_3370 <- st_buffer(road, dist = 3370) #100% jumps
st_write(road_3370, file.path(here(), "figures", "GIS", "road_buffer_3370.shp"))

road_2970 <- st_buffer(road, dist = 2970) #95% jumps
st_write(road_2970, file.path(here(), "figures", "GIS", "road_buffer_2970.shp"))

road_980 <- st_buffer(road, dist = 980) #75% jumps
st_write(road_980, file.path(here(), "figures", "GIS", "road_buffer_980.shp"))


# Intersections
# Full dataset
Rail_road_full_100 <- st_intersection(rail_21180, road_3570)
st_write(Rail_road_full_100, file.path(here(), "figures", "GIS", "road_rail_intersect_full_100.shp"))

Rail_road_full_95 <- st_intersection(rail_6570, road_1810)
st_write(Rail_road_full_95, file.path(here(), "figures", "GIS", "road_rail_intersect_full_95.shp"))

Rail_road_full_75 <- st_intersection(rail_1340, road_730)
st_write(Rail_road_full_75, file.path(here(), "figures", "GIS", "road_rail_intersect_full_75.shp"))

# Rare dataset
Rail_road_rare_100 <- st_intersection(rail_9790, road_3370)
st_write(Rail_road_rare_100, file.path(here(), "figures", "GIS", "road_rail_intersect_rare_100.shp"))

Rail_road_rare_95 <- st_intersection(rail_7120, road_2970)
st_write(Rail_road_rare_95, file.path(here(), "figures", "GIS", "road_rail_intersect_rare_95.shp"))

Rail_road_rare_75 <- st_intersection(rail_2590, road_980)
st_write(Rail_road_rare_75, file.path(here(), "figures", "GIS", "road_rail_intersect_rare_75.shp"))
dim(Rail_road_rare_75)
```

```{r map risk buffer}

rail_6570 <- st_read(file.path(here(), "figures", "GIS", "rail_buffer_6570.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  geom_sf(data = rail_6570, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_rail_6570.jpg"), rail, width = 6, height = 6)


####


rail_1340 <- st_read(file.path(here(), "figures", "GIS", "rail_buffer_1340.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  geom_sf(data = rail_1340, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_rail_1340.jpg"), rail, width = 6, height = 6)



####


rail_21180 <- st_read(file.path(here(), "figures", "GIS", "rail_buffer_21180.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  # geom_sf(data = rail_21180, fill = "yellow", col = "yellow") +
    geom_sf(data = rail_6570, fill = "orange", col = "orange") +
    geom_sf(data = rail_1340, fill = "red", col = "red") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_rail_95_75.jpg"), rail, width = 6, height = 6)




### roads

####


road_1810 <- st_read(file.path(here(), "figures", "GIS", "road_buffer_1810.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  # geom_sf(data = rail_21180, fill = "yellow", col = "yellow") +
    # geom_sf(data = rail_6570, fill = "orange", col = "orange") +
    geom_sf(data = road_1810, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_road_1810.jpg"), rail, width = 6, height = 6)



### 

road_730 <- st_read(file.path(here(), "figures", "GIS", "road_buffer_730.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  # geom_sf(data = rail_21180, fill = "yellow", col = "yellow") +
    # geom_sf(data = rail_6570, fill = "orange", col = "orange") +
    geom_sf(data = road_730, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_road_730.jpg"), rail, width = 6, height = 6)



## intersect

road_rail_75 <- st_read(file.path(here(), "figures", "GIS", "road_rail_intersect_full_75.shp"), quiet = T)


# Visualize shapefiles
rail <- ggplot(data = states) +
    geom_sf(data = states, fill = "white") +
  # geom_sf(data = rail_21180, fill = "yellow", col = "yellow") +
    # geom_sf(data = rail_6570, fill = "orange", col = "orange") +
    geom_sf(data = road_rail_75, fill = "orange", col = "orange") +
  geom_sf(data = states, alpha = 0) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top") +
    # coord_sf(xlim = c(-90, -70), ylim = c(30, 45))
  coord_sf(xlim = c(500000, 2000000), 
           ylim = c(-900000, 700000))

ggsave(file.path(here(), "figures", "GIS_roadrail_75.jpg"), rail, width = 6, height = 6)

aaa
```

