---
title: "Making the most of invasion records, the case of the spotted lanternfly, part III: Extending knowledge on jump dispersal to Pennsylvania"
author: 
- Nadege Belouard^[Temple University, nadege.belouard@temple.edu]
- Sebastiona De Bona^[Temple University, seba.debona@temple.edu]
- Jocelyn E. Behm^[Temple University, jebehm@temple.edu]
- Matthew R. Helmus^[Temple University, mrhelmus@temple.edu]
date: "10/25/2021"
output:
  pdf_document:
    toc: TRUE
    toc_depth: 2
  html_document:
    toc: TRUE
    toc_depth: 3
params:
  show_code: FALSE
  export_figures: TRUE
---

```{r setup for rendering, include = F}
# here we set the images to png, to reduce the size of the output
# we set some global paramters in the yaml to allow us to switch the chunks
# of code on and off when displaying
knitr::opts_chunk$set(dpi = 300, echo = params$show_code)
```

\newpage

# Aim and setup
 
A list of areas considered at high risk of colonization by the spotted lanternfly (SLF) in Pennsylvania has been built by the iEcolab (see SLF dashboard). We want to investigate the relationship between these high-risk locations and the observed occurrences of jump dispersal of the SLF, i.e. established populations found far away from the invasion core. We generated a list of 'jumpers' (jump dispersal events) in a companion vignette.

In the present vignette, 

(1) We will test whether jump dispersal occurs close to high-risk locations, and whether this differs from where other SLF populations (diffusers) are found. We will also confirm that surveys are not spatially biased towards these high-risk locations but spread across PA. To do this, we will calculate the distance of jumpers, diffusers and non-detections to the closest high-risk location, and test whether these distances are shorter than random using a bootstrapped distribution.

(2) We will use the knowledge we have on the location of SLF jumpers relative to transports to project potential areas of colonization in Pennsylvania. We will assess the proportion of high-risk locations that are situated in this zone, and whether there are variations between categories of high-risk locations, to see if some categories are more likely to be subject to SLF jump dispersal.


IMPORTANT NOTE: This vignette is currently being revised to (1) improve the algorithm detecting jump dispersal, (2) improve categories of high-risk locations and produce their respective risk estimates, and (3) be extended to the rest of the United States. Updated results will be available by the end of 2021, and we do not expect results to change qualitatively.


```{r load landscape features, warning = F, message = F}

library(tidyverse)
library(sf)
library(spData)
library(dplyr)
library(reshape2)
library(magrittr)

# SLF data (in the folder SLF_datascience)
grid_DP16GS15 <- read_csv("../exported-data/Distances_observed/grid_cat_DP16GS15.csv")
grid_layer <- st_as_sf(x = grid_DP16GS15, coords = c("longitude_rounded", "latitude_rounded"), crs = 4326, remove = F)
grid_proj <- st_transform(grid_layer, crs = 4326)

#Keep a landscape layer for crs
# Landscape features
airports <- st_read("C:/Users/labuser/Documents/Postdoc_SLF/SLF_Dispersal/data/raw_data/Transport/Airports/Airports_merged_projected.shp", quiet = T)
rail <- st_read("C:/Users/labuser/Documents/Postdoc_SLF/SLF_Dispersal/data/raw_data/Transport/Railroads/Railways_merged_projected.shp", quiet = T)
road <- st_read("C:/Users/labuser/Documents/Postdoc_SLF/SLF_Dispersal/data/raw_data/Transport/Roads/Prisec_roads/Prisec_roads_merged_projected.shp", quiet = T)

states <- sf::st_as_sf(maps::map("state", plot = F, fill = T))
pennsylvania <- states %>% filter(ID == "pennsylvania")
pennsylvania <- st_make_valid(pennsylvania)
```


# 1. Do we observe jump dispersal preferentially at high-risk locations?

We first want to check whether SLF are preferentially established near high-risk locations, and whether there is a difference between jumpers, diffusers and non-detections. Because we have listed high-risk locations in PA only, we subset the jumpers, diffusers and non-detections datasets to points situated in PA only.

```{r load file of high risk areas}
# Landscape features
Highrisk <- read.csv("../exported-data/highrisk.csv")
Highrisk_layer <- st_as_sf(x = Highrisk, coords = c("Longitude", "Latitude"), crs = 4326)
Highrisk_proj <- st_transform(Highrisk_layer, crs = 4326)
```

## A- Visual estimates 

```{r average values for jumpersPA}
jumpers_PA <- read.csv("../exported-data/Distances_observed/old/jumpersPA_distances.csv", h=T)
# jumpers_PA <- grid_PA %>% filter(Category == "Jumpers")

#Keep the average in a table
# Data_disttoairportPA = mean(jumpers_PA$DistToAirport) #6615
# Data_disttorailPA = mean(jumpers_PA$DistToRail) #660
# Data_disttoroadPA = mean(jumpers_PA$DistToRoad) #510
Data_disttohighriskPA = mean(jumpers_PA$DistToHighRisk) #601
``` 

The 45 jumpers are situated on average at `r round(Data_disttohighriskPA,0)` m of a high-risk location. 


```{r average values for diffusersPA}
diffusers_PA <- read.csv("../exported-data/Distances_observed/old/diffusersPA_distances.csv", h=T)
# diffusers_PA <- grid_PA %>% filter(Category == "Diffusers")

#Keep the average in a table
# Diffusers_disttoairportPA = mean(diffusers_PA$DistToAirport) #6279
# Diffusers_disttorailPA = mean(diffusers_PA$DistToRail) #3134
# Diffusers_disttoroadPA = mean(diffusers_PA$DistToRoad) #1181
Diffusers_disttohighriskPA = mean(diffusers_PA$DistToHighRisk) #2573
``` 

The 4,941 diffusers in PA are situated on average at `r round(Diffusers_disttohighriskPA,0)` m of a high-risk location. 


```{r average values for undetectedPA}
negatives_PA <- read.csv("../exported-data/Distances_observed/old/undetectedPA_distances.csv", h=T)
# negatives_PA <- grid_PA %>% filter(Category == "Negatives")

#Keep the average in a table
# undetected_disttoairportPA = mean(negatives_PA$DistToAirport) #7106
# undetected_disttorailPA = mean(negatives_PA$DistToRail) #5077
# undetected_disttoroadPA = mean(negatives_PA$DistToRoad) #1046
undetected_disttohighriskPA = mean(negatives_PA$DistToHighRisk) #2300
``` 

The 21,894 negative surveys in PA are situated on average at `r round(undetected_disttohighriskPA,0)` m of a high-risk location.

```{r Distance of all sites to transport infrastructures}
#Keep the average in a table
# total_disttoairportPA = mean(totalPA$DistToAirport) # 6953
# total_disttorailPA = mean(totalPA$DistToRail) # 4712 
# total_disttoroadPA = mean(totalPA$DistToRoad) # 1070
grid_PA <- rbind(jumpers_PA %>% mutate(Category = "Jumpers"), 
                 diffusers_PA %>% select(-SpreadCat) %>% mutate(Category = "Diffusers"),
                 negatives_PA %>% mutate(Category = "Negatives"))
total_disttohighriskPA = mean(grid_PA$DistToHighRisk) # 2347


grid_PA$Category <- factor(grid_PA$Category, levels = c("Jumpers", "Diffusers", "Negatives"))
```

```{r plot histogram of distances to high risk per category of SLF, fig.height=3, fig.width = 6, fig.cap="Distance of jumpers, diffusers and non-detections to high-risk locations. The y axis is truncated to better show the boxes."}

# Plot distances 
disttohighrisk <- ggplot(grid_PA, aes(y = DistToHighRisk, x = Category)) + 
  geom_boxplot() +
  coord_cartesian(ylim=c(0, 10000)) +
  theme_classic() +
  labs(x=NULL) +
  ylab("Nearest high-risk area (m)")

disttohighrisk

# ggsave("../figures/vignette_highrisk/disttohighrisk.jpg", disttohighrisk, width = 6, height = 3)
```

In Figure 1, we can see that on average, jumpers are located closer to high-risk locations than diffusers and negative surveys.

\newpage

## B- Comparison of observed distances to a random distribution of distances to high-risk locations

We now compare whether the 45 SLF jumps are situated significantly closer than random to these high-risk locations by using a null distribution. The idea is to generate a distribution of distances to high-risk locations under the null hypothesis that SLF disperse randomly in the landscape. If a high number of random distributions are generated, we obtain the distribution of random dispersal distances to transports. The comparison of the random distribution and the observed average value gives the probability that the observed value is random.  

Here, we generate 9,999 random datasets of distances to high-risk locations. If the average value of the observed data is comprised within the simulated random values, it means that the pattern could be found by chance, and the distance between observed points and high-risk locations is not significant.
Clearly, it consists in: (1) generating a dataset of the same number of points as in the observed data, randomly over the same geographic area, (2) for each random point, calculating the distance to the nearest high-risk location, (3) taking the average distance for the dataset, (4) going over the same cycle again for a total of 9,999 simulated random datasets.


```{r plot null distribution to high risk, fig.height=2, fig.width = 6, fig.cap="Comparison of the distance of jumpers to high-risk locations to a random distribution."}

MeanDistances <- read.csv("../exported-data/Distances_random distrib/75 samples jumpers/means_randomjumpersPA_highrisk.csv")

highrisk.quant <- quantile(MeanDistances$MeanHighRisk,c(.025,.975))

random_jumperstohighrisk <- ggplot(data = MeanDistances, aes(x =  MeanHighRisk)) +
  geom_histogram(aes(x =  MeanHighRisk/1000), binwidth= 0.1, col = "black") +
  geom_vline(xintercept = mean(jumpers_PA$DistToHighRisk)/1000, size = 1, col = "red") +
  # geom_vline(xintercept = mean(diffusersPA_proj$DistToHighRisk)/1000, size = 1, col = "blue") +
  # geom_vline(xintercept = mean(undetectedPA_proj$DistToHighRisk)/1000, size = 1, col = "green") +
  geom_vline(xintercept = highrisk.quant[1]/1000, size = 1, col = "black") +
  geom_vline(xintercept = highrisk.quant[2]/1000, size = 1, col = "black") +
  xlab("Distance (km)") +
  ylab("") +
  coord_cartesian(xlim = c(0, 5)) + 
  ggtitle("High risk areas") +
  theme_classic()

random_jumperstohighrisk

# ggsave("../figures/vignette_highrisk/random_jumperstohighrisk.jpg", random_jumperstohighrisk, width = 6, height = 3)
```

We can visualize the results on Figure 2. The histogram represents the distribution of distances to high-risk locations under the null hypothesis of random dispersal of jumpers. The black vertical lines indicate the significance limits. An observed value situated outside of these vertical lines leads to the rejection of the null hypothesis. The red line indicates the average distance between jumpers and high-risk locations observed in our dataset. Here, the observed location of jumpers is significantly closer than random (outside of the significance limits) to high-risk locations.  


We would like to do the same analysis for diffusers and negative surveys, but these datasets are much bigger, so the generation of 9,999 simulated datasets is much longer. As a first approach, we bootstrap the diffusers and undetected datasets, to obtain average distances based on datasets with the same number of surveys as of jumpers. We sample 45 points in the diffusers and undetected datasets, take the average distance to each transport, and repeat 9,999 times to obtain an average value that can be compared to the random distribution that we already have, before leading time-consuming simulations.


```{r plot null distribution to high risk with other categories, fig.height=2, fig.width = 6, fig.cap="Comparison of the distance of jumpers, diffusers and non-detections to high-risk locations to a random distribution."}
# MeanDistances <- read.csv("../exported-data/Distances_random distrib/means_randomjumpersPA_highrisk.csv")
# highrisk.quant <- quantile(MeanDistances$MeanHighRisk,c(.025,.975))
jumpersPA_proj <- jumpers_PA
DiffusersPA_bootstrap <- read.csv("../exported-data/Distances_random distrib/75 samples jumpers/DiffusersPA_bootstrap.csv")
UndetectedPA_bootstrap <- read.csv("../exported-data/Distances_random distrib/75 samples jumpers/UndetectedPA_bootstrap.csv")
TotalPA_bootstrap <- read.csv("../exported-data/Distances_random distrib/75 samples jumpers/TotalPA_bootstrap.csv")


random_tohighrisk <- ggplot(data = MeanDistances, aes(x =  MeanHighRisk)) +
  geom_histogram(aes(x =  MeanHighRisk/1000), binwidth= 0.1, col = "black") +
  geom_vline(xintercept = mean(jumpersPA_proj$DistToHighRisk)/1000, size = 1, col = "red") +
  geom_vline(xintercept = mean(DiffusersPA_bootstrap$DistToHighRisk, na.rm=TRUE)/1000, size = 1, col = "blue") +
  geom_vline(xintercept = mean(UndetectedPA_bootstrap$DistToHighRisk, na.rm=TRUE)/1000, size = 1, col = "green") +
  geom_vline(xintercept = highrisk.quant[1]/1000, size = 1, col = "black") +
  geom_vline(xintercept = highrisk.quant[2]/1000, size = 1, col = "black") +
  xlab("Distance (km)") +
  ylab("") +
  coord_cartesian(xlim = c(0, 5)) + 
  ggtitle("High risk areas") +
  theme_classic()

random_tohighrisk

# ggsave("../figures/vignette_highrisk/random_tohighrisk.jpg", random_tohighrisk, width = 6, height = 3)
```

Figure 3 shows the significance of the observed distances of diffusers (blue line) and non-detections (green line) to high risk locations, compared to a random distribution. Jumpers are closer to high risk locations than diffusers. Negative surveys are randomly situated relative to high risk locations.

\newpage  

# 2. Intersection of jumps around transports and high-risk locations

SLF spread is suspected to be facilitated by human-assisted dispersal, i.e. hitchhiking on human transportation. If we create a buffer around roads and railways so as to include all jumpers that were found, we can design a map of locations at risk of jump dispersal (Figure 4). In other words, all jump dispersal identified so far occurred within the orange buffer. This type of map can be used to concentrate survey efforts on locations considered at risk based on spread records.

```{r show buffer intersecting road and rail, fig.height=4, fig.width = 6, fig.cap="Buffer zones around railways and roads that include all jumpers"}

Railroad_buffer <- st_read("../GIS/intersect_road_rail_jumpers_100.shp", quiet = T)



Buffer_risk <- ggplot(data = world) +
    geom_sf() +
    geom_sf(data = states, fill = "white") +
    geom_sf(data = Railroad_buffer, fill = "orange") +
    coord_sf(xlim = c(-81, -73), ylim = c(38, 42.5), expand = FALSE) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top")

Buffer_risk

# ggsave("../figures/vignette_highrisk/bufferrisk_railroad.jpg", Buffer_risk, width = 6, height = 4)
```

It is interesting to see whether high-risk locations are situated in this risk buffer where actual jump events were found. On Figure 5, green-blue points represent high-risk locations situated within the risk buffer, and red points are high-risk locations outside of this buffer. A substantial proportion of high-risk locations are thus at risk. We can look further into it by checking whether this varies between categories of high-risk locations.

```{r show buffer intersecting road and rail with high risk areas, fig.height=4, fig.width = 6, fig.cap="Location of high-risk locations relative to the buffer zones including all jumpers"}
HighRiskLoc <- st_read("../GIS/HighRiskLoc.shp", quiet = T)

Highrisk_buffer <- ggplot(data = world) +
    geom_sf() +
    geom_sf(data = states, fill = "white") +
    # geom_sf(data = Railroad_buffer, fill = "orange") +
  geom_sf(data = HighRiskLoc, aes(col = InBuffer)) +
    coord_sf(xlim = c(-81, -73), ylim = c(38, 42.5), expand = FALSE) +
    labs(x = "Longitude", y = "Latitude")+
    theme(legend.position="top")

Highrisk_buffer

# ggsave("../figures/vignette_highrisk/highrisk_buffer.jpg", Highrisk_buffer, width = 6, height = 6)
```


```{r barplot of the proportion of high-risk locations included in risk buffer per category, fig.height=3, fig.width = 9, fig.cap="Proportion of in-buffer high-risk locations per category"}

Prophighrisk_inbuffer <- ggplot(HighRiskLoc, aes(x = category)) + 
  geom_bar(aes(fill = InBuffer), position="fill") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

Prophighrisk_inbuffer

# ggsave("../figures/vignette_highrisk/Prophighrisk_inbuffer.jpg", Prophighrisk_inbuffer, width = 9, height = 3)
```

We notice on Figure 6 that, for example, all intermodal platforms are situated in the risk buffer. By contrast, most campgrounds, race tracks, saw mills and summer camps are situated outside of the risk buffer. It could mean that these locations are generally not at risk compared to the others.

\newpage 

# 3. Results and conclusion


In this vignette, we found that:  

(1) Jumpers and diffusers are situated significantly close to high-risk locations. These high-risk locations could be preferential locations for the progression of the invasion.

(2) We created a risk buffer around transport infrastructures comprising all jump events so far. This risk buffer could be used as a guide to focus survey efforts and ensure an early detection of future jump events.

(3) Categories of high-risk locations are not equally close to transport infrastructures. Further work is necessary to assess the risk of jump dispersal in each category.


This vignette concludes a series of 3 vignettes on the analysis of spread records of the spotted lanternfly. Results can be used to improve our knowledge of SLF dispersal, to follow the evolution of the invasion, and to direct survey efforts.